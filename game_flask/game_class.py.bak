from use import Game

class Normal:
    """
    æ™®é€šè½®ç›˜èµŒæ¨¡å¼ç±»

    å±æ€§:
    game_player_list(list):å¯¹æˆ˜ç©å®¶åˆ—è¡¨
    obj(Game):æ¸¸æˆåº•å±‚é€»è¾‘ç±»
    res(dict):é“å…·å¯¹ç…§è¡¨
    """
    def __init__(self) -> None:
        self.game_player_list=[]
        self.obj:Game=None
        self.run=False
        self.res={"1":"ğŸ”ª",
                "2":"ğŸš¬",
                "3":"ğŸ”",
                "4":"â›“ï¸",
                "5":"ğŸº"}
    def in_room(self,player_id)->bool:
        """
        è·å–ç©å®¶æ˜¯å¦åœ¨æˆ¿é—´

        è¿”å›å€¼:
        bool:True(åœ¨)/False(ä¸åœ¨)
        
        """
        return player_id in self.game_player_list 
    
    def add_game(self,player_id)->str:
        """
        åŠ å…¥å¯¹æˆ˜æˆ¿é—´

        å‚æ•°:
        player_id(str):è¿›å…¥æˆ¿é—´ç©å®¶id


        è¿”å›å€¼:
        str:æ‰§è¡Œä»£ç çŠ¶æ€
        """
        msg=''
        if len(self.game_player_list) < 2 and not self.in_room(player_id):
            self.game_player_list.append(player_id)
            msg+=f'({player_id})åŠ å…¥æˆ¿é—´æˆåŠŸ!'
            return msg
        else:
            msg+=f'({player_id})å·²åœ¨æˆ¿é—´!'
            return msg

    def start_game(self,player_id):
        """
        å¯åŠ¨æ¸¸æˆ

        å‚æ•°:
        player_id(str):å‘èµ·å¼€å§‹æ¸¸æˆç©å®¶
        
        è¿”å›å€¼:
        str:æ‰§è¡Œä»£ç çŠ¶æ€
        """
        msg=''
        if self.run and player_id in self.game_player_list:
            msg+='æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­...'
            return msg
        else:
            if len(self.game_player_list)==2:
                self.run=True
                self.obj=Game(*self.game_player_list)
                self.obj.game_init()
                z,j=self.obj.generate_random_clip_init()
                msg+=f"å½“å‰å¼¹å¤¹æƒ…å†µ\nå®:{z}\nç©º:{j}\n[{self.obj.ammo.id}]çš„å›åˆ"
                return msg

            else:
                msg+="äººæ•°ä¸å¤Ÿæ— æ³•å¼€å§‹æ¸¸æˆ"
                return msg
            
    def shoot_game(self,player_id,id_):
        """
        å¼€æª

        å‚æ•°:
        player_id(str):æ”»å‡»ç©å®¶id
        id_(str):å¯¹è±¡é€‰æ‹©id(0ä¸ºè‡ªå·±,1ä¸ºå¯¹æ–¹)

        è¿”å›å€¼:
        str:æ‰§è¡Œä»£ç çŠ¶æ€
        """
        msg=''
        if not self.in_room(player_id):
            msg+='æ‚¨ä¸åœ¨æœ¬å±€æ¸¸æˆ'
            return msg
        if not self.obj.ammo.sx["pass"]:
            self.obj.ammo.sx["pass"]=True
            self.obj.ammo=self.obj.rival()
        if self.obj.ammo.id==player_id:
            if id_ not in ['1','0']:
                msg+="å¯¹è±¡é”™è¯¯"
                return msg
            gj=self.obj.ammo
            bgj=gj if id_=="0" else self.obj.rival()
            tag,atk_num=self.obj.shoot(gj,bgj)
            msg=''
            if tag==0:
                msg+=f"ä½ å¯¹è‡ªå·±({gj.id})å¼€å‡ºçœŸæªé€ æˆ{atk_num}ç‚¹ä¼¤å®³\n"
            elif tag==1:
                msg+=f"ä½ ({gj.id})å¼€å‡ºçœŸæªå¯¹ç©å®¶({bgj.id})é€ æˆ{atk_num}ç‚¹ä¼¤å®³\n"
            elif tag==2:
                msg+=f"ä½ ({gj.id})å¯¹è‡ªå·±å¼€å‡ºç©ºæª,å»¶ç»­ä¸€å›åˆ\n"
            elif tag==3:
                msg+=f"ä½ ({gj.id})å¯¹ç©å®¶({bgj.id})å¼€å‡ºç©ºæª\n"
            
            win=False
            if self.obj.player1.sx["hp"]<=0 or self.obj.player2.sx["hp"]<=0:
                
                msg+="\n\n\n<æ¸¸æˆç»“æŸ>\n\n"
                if self.obj.player1.sx["hp"]>=1:
                    msg+=f">>>{self.obj.player1.id}èƒœåˆ©<<<"
                    self.obj.player1.data["gold"]+=300
                    self.obj.player1.data["win"]+=1
                    self.obj.player1.data["total"]+=1
                    self.obj.player1.save()
                    #self.obj.player2.data["gold"]+=300
                    self.obj.player2.data["loss"]+=1
                    self.obj.player2.data["total"]+=1
                    self.obj.player2.save()
                else:
                    msg+=f">>>{self.obj.player2.id}èƒœåˆ©<<<"
                    self.obj.player2.data["gold"]+=300
                    self.obj.player2.data["win"]+=1
                    self.obj.player2.data["total"]+=1
                    self.obj.player2.save()
                   # self.obj.player1.data["gold"]+=300
                    self.obj.player1.data["loss"]+=1
                    self.obj.player1.data["total"]+=1
                    self.obj.player1.save()
                msg+="\nå¥–é‡‘300"
                self.game_player_list=[]
                self.obj:Game=None
                self.run=False
                return msg
            if not win:
                if self.obj.gone_atk==2:
                    self.obj.gone_atk=1
                    msg+="\n[æªçš„ä¼¤å®³é‡ç½®äº†]\n"
                if len(self.obj.ammo_list)==0:
                    z,j=self.obj.generate_random_clip_init()
                    w=self.obj.get_res()
                    
                    msg+=f"\nå­å¼¹å·²å°„å®Œé‡æ–°ç”Ÿæˆå¼¹å¤¹:\nå®:{z}\nç©º:{j}\nåŒæ–¹è·å¾—ç‰©å“:\n{self.obj.player1.id}\n{[self.res[i] for i in w[self.obj.player1.id]]}\n{self.obj.player2.id}\n{[self.res[i] for i in w[self.obj.player2.id]]}\n\nå½“å‰æ˜¯[{self.obj.ammo.id}]å›åˆ"

        else:
            msg+="ä¸æ˜¯æ‚¨çš„å›åˆ"
        return msg
    def use_game(self,player_id,id_):
        """
        ä½¿ç”¨é“å…·

        å‚æ•°:
        player_id(str):ä½¿ç”¨é“å…·ç©å®¶
        id_(str):é“å…·id

        è¿”å›å€¼:
        str:æ‰§è¡Œä»£ç çŠ¶æ€
        """
        msg=''
        if not self.in_room(player_id):
            msg+='æ‚¨ä¸åœ¨æœ¬å±€æ¸¸æˆ'
            return msg
        sk_tag=0
        if not self.obj.ammo.sx["pass"]:
                sk_tag=1
                self.obj.ammo.sx["pass"]=True
                self.obj.ammo=self.obj.rival()
        cmd=id_
        
        game=self.obj
        if self.obj.ammo.id==player_id:
            
            if cmd=='1':
                if game.ammo.sx["res"][cmd]>0 and game.gone_atk==1:
                    msg+="æªçš„ä¼¤å®³åŠ 1"
                    game.ammo.sx["res"][cmd]-=1
                    game.gone_atk+=1
                else:
                    msg+=f"{self.res[cmd]}æ•°é‡ä¸è¶³æˆ–è€…å·²ä½¿ç”¨:å½“å‰æªçš„ä¼¤å®³:{game.gone_atk}"
            elif cmd=='2':
                if game.ammo.sx["res"][cmd]>0:
                    game.ammo.sx["hp"]+=1
                    msg+=f"ä½ ({game.ammo.id})çš„è¡€é‡+1,å½“å‰è¡€é‡:{game.ammo.sx['hp']}"
                    
                    game.ammo.sx["res"][cmd]-=1
                else:
                    msg+=f"{self.res[cmd]}æ•°é‡ä¸è¶³"
            elif cmd=='3':
                if game.ammo.sx["res"][cmd]>0:
                    msg+=f"å½“å‰å­å¼¹ä¸º[{'å®å¼¹' if game.ammo_list[-1] else 'ç©ºå¼¹'}]"
                    game.ammo.sx["res"][cmd]-=1
                else:
                    msg+=f"{self.res[cmd]}æ•°é‡ä¸è¶³"
            elif cmd=='4':
                
                if game.ammo.sx["res"][cmd]>0:
                    
                    if not game.rival().sx["pass"] or sk_tag:
                        msg+=f"å¯¹æ–¹({ game.rival().id})å·²è¢«æ§åˆ¶æ— éœ€å†æ¬¡ä½¿ç”¨"
                    else:
                        msg+=f"å¯¹æ–¹({ game.rival().id})å·²è¢«æ§åˆ¶å¯¹æ–¹ä¸‹å›åˆæ— æ³•è¡ŒåŠ¨"
                        game.rival().sx["pass"]=False
                        game.ammo.sx["res"][cmd]-=1
                else:
                    print(f"{self.res[cmd]}æ•°é‡ä¸è¶³")
            elif cmd=='5':
                if game.ammo.sx["res"][cmd]>0:
                    msg+=f"é€€å‡ºçš„å­å¼¹ä¸º[{'å®å¼¹' if game.ammo_list.pop() else 'ç©ºå¼¹'}]"
                    game.ammo.sx["res"][cmd]-=1
                    if len(game.ammo_list)==0:
                        z,j=self.obj.generate_random_clip_init()
                        msg+=f"\nå­å¼¹å·²é€€å®Œé‡æ–°ç”Ÿæˆå¼¹å¤¹:\nå®:{z}\nç©º:{j}\nå½“å‰æ˜¯[{game.ammo.id}]å›åˆ"
                    
                else:
                    msg+=f"{self.res[cmd]}æ•°é‡ä¸è¶³"
        
            else:
                msg+="ç‰©å“ä¸å­˜åœ¨"
            return msg
        else:
            msg+="ä¸æ˜¯æ‚¨çš„å›åˆ"
            return msg
        
    def look_res(self,player_id):
        """
        æŸ¥çœ‹ç‰©å“

        å‚æ•°:
        player_id(str):æŸ¥çœ‹ç‰©å“ç©å®¶id
 
        è¿”å›å€¼:
        str:æ‰§è¡Œä»£ç çŠ¶æ€
        """
        if not self.in_room(player_id):
            msg+='æ‚¨ä¸åœ¨æœ¬å±€æ¸¸æˆ'
            return msg
        msg="åŒæ–¹ç‰©å“æƒ…å†µ\n"
        msg+='ğŸ”ª(id:1):[å½“å‰å›åˆä¼¤å®³+1]\n'
        msg+='ğŸš¬(id:2):[å›å¤ä¸€æ ¼âš¡]\n'
        msg+='ğŸ”(id:3):[æŸ¥çœ‹å½“å‰å­å¼¹]\n'
        msg+='â›“ï¸(id:4):[é™åˆ¶å¯¹æ–¹ä¸€å›åˆ]\n'
        msg+='ğŸº(id:5):[é€€å‡ºæªé‡Œå½“å‰å­å¼¹]\n'
        r={
            "1":"ğŸ”ª\tæ•°é‡:{}",
            "2":"ğŸš¬\tæ•°é‡:{}",
            "3":"ğŸ”\tæ•°é‡:{}",
            "4":"â›“ï¸\tæ•°é‡:{}",
            "5":"ğŸº\tæ•°é‡:{}"
        }
        msg+=f'{self.obj.player1.id}[âš¡x{self.obj.player1.sx["hp"]}]\n'
        for i,j in self.obj.player1.sx["res"].items():
            msg+="{}\n".format(r[i].format(j))
        msg+=f'\n\n{self.obj.player2.id}[âš¡x{self.obj.player2.sx["hp"]}]\n'
        for i,j in self.obj.player2.sx["res"].items():
            msg+="{}\n".format(r[i].format(j))
        msg+="å¼¹å¤¹æƒ…å†µ:"
        true_ammo = self.obj.ammo_list.count(1)
        false_ammo = self.obj.ammo_list.count(0)
        msg+=f"[å®:{true_ammo}] [ç©º:{false_ammo}]"
        return msg